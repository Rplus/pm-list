"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,a=Array(e.length);t<e.length;t++)a[t]=e[t];return a}return Array.from(e)}window.$=document.querySelector.bind(document),window.$$=document.querySelectorAll.bind(document);var toJSON=function(e){return e.json()};window.lang=new URLSearchParams(location.hash.replace(/^#/,"")).get("lang")||navigator.language.split("-")[0];var elm={app:$(".app"),list:$(".list"),saved:$(".saved-lists"),title:$(".title"),reset:$(".reset"),setName:$(".set-name"),export:$(".export"),exportLink:$(".export-link"),checkedNum:$(".checked-num"),copy:$(".copy"),inverseCopy:$(".inverse-copy")},pmMap={dex:[],elm:{},state:{}},init=function(){var e=new URLSearchParams(location.search),t=e.get("name"),a=e.get("dex")||"",n=t&&!!localStorage.getItem("T="+t)&&confirm("Confirm to overwirte "+t+"?");(n||t)&&localStorage.setItem("T="+t,a);var r=n?t:localStorage.getItem("latestName")||"",i=localStorage.getItem("T="+r)||"";if(r&&(list.name=r),i){var l=i.split("-").filter(Boolean);l=[].concat(_toConsumableArray(new Set(l))),(pmMap.dex=l).forEach(function(e){updatePmState(e,!0)})}history.pushState(null,null,location.href.replace(location.search,"")),renderSavedNames()},renderSavedNames=function(){elm.saved.innerHTML=Object.keys(localStorage).filter(function(e){return/^T\=/.test(e)}).map(function(e){return'<li>\n        <button data-name="'+e+'" data-action="delete">x</button>\n        <button data-name="'+e+'" data-action="replace">'+e.replace(/^T\=/,"")+"</button>\n      </li>"}).join("")};renderSavedNames();var list={set name(e){this.input.value!==e&&(this.input.value=e),localStorage.setItem("latestName",e)},get name(){return this.input.value},input:elm.title},updateMutilState=function(e){for(var t in pmMap.state){var a=pmMap.state[t],n=-1!==e.indexOf(t)?1:0;n!==a&&updatePmState(t,n)}};elm.reset.addEventListener("click",function(){confirm("將清除 [ "+list.name+" ] 目前的勾選，是否繼續？")&&updateMutilState([])}),elm.setName.addEventListener("click",function(){saveState(),renderSavedNames()}),elm.saved.addEventListener("click",function(e){var t=e.target;if(t.dataset&&t.dataset.action)switch(t.dataset.action){case"delete":confirm("將刪除 [ "+t.dataset.name.replace(/^T\=/,"")+" ] 紀錄，是否繼續？")&&localStorage.removeItem(t.dataset.name),renderSavedNames();break;case"replace":list.name=t.dataset.name.replace(/^T\=/,"");var a=localStorage.getItem(t.dataset.name).split("-");updateMutilState(a)}});var SPRITE_COL=31,img=function(e){var t=e-1;return"--pm-row: "+~~(t/SPRITE_COL)+"; --pm-col: "+t%SPRITE_COL},genPM=function(e){return'<div class="pm" data-dex="'+e.dex+'" data-state="'+e.state+'" style="'+img(e.dex)+'" title="'+e.en+'">'+e.dex+" "+e.name+"</div>"},renderList=function(e){elm.list.innerHTML=e.map(genPM).join(""),elm.list.addEventListener("click",clickPM),[].slice.apply($$(".pm")).forEach(function(e){var t=e.dataset;pmMap.elm[t.dex]=e,pmMap.state[t.dex]=+t.state}),init()},clickPM=function(e){var t=e.target;t.classList.contains("pm")&&updatePmState(t.dataset.dex,!+t.dataset.state)},updatePmState=function(e,t){var a=t?1:0;pmMap.elm[e].dataset.state=a,pmMap.state[e]=a,saveState(),updateChecked()},updateChecked=function(e){var t=0<arguments.length&&void 0!==e?e:1,a=Object.keys(pmMap.state).filter(function(e){return pmMap.state[e]===t});elm.checkedNum.value=a.join(),elm.copy.dataset.count=a.length};elm.inverseCopy.addEventListener("click",function(){elm.inverseCopy.dataset.checkedstate=+elm.inverseCopy.dataset.checkedstate?0:1,updateChecked(+elm.inverseCopy.dataset.checkedstate)}),elm.copy.addEventListener("click",function(){elm.checkedNum.select(),document.execCommand("copy"),alert("已複製!\n"+elm.checkedNum.value),elm.checkedNum.blur()});var saveState=function(){var e=Object.keys(pmMap.state).filter(function(e){return pmMap.state[e]}).join("-");localStorage.setItem("T="+list.name,e),list.name=list.name},remap=function(e){var t=[];for(var a in e){var n=e[a][lang]||e[a].en;t[+a]={name:n,en:e[a].en,dex:+a,state:0}}return t.filter(Boolean)};fetch("./pm-name.json").then(toJSON).then(remap).then(renderList),elm.export.addEventListener("click",function(){saveState();var t=list.name,e=new URLSearchParams({name:t,dex:localStorage.getItem("T="+t)});elm.exportLink.href="./",elm.exportLink.search=e.toString(),elm.exportLink.innerText="...";var a="https://cors-anywhere.herokuapp.com/tinyurl.com/api-create.php?url="+elm.exportLink.href;fetch(a).then(function(e){return e.text()}).then(function(e){console.log(e),elm.exportLink.href=e,elm.exportLink.innerText=t+": "+e})});